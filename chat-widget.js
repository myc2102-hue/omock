import { db } from './data.js';

// ============================================================
// 1. [í•µì‹¬] ì‚¬ì´íŠ¸ ë¦¬ì†ŒìŠ¤ ê¸°ë°˜ PPT ìƒì„±ê¸° (ì´ë¯¸ì§€ ê²½ë¡œ ì™„ë²½ ìˆ˜ì •íŒ)
// ============================================================

async function createDynamicPPT() {
    // 1. ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì²´í¬
    if (typeof window.PptxGenJS === 'undefined') {
        throw new Error("PptxGenJS ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (HTML í—¤ë” í™•ì¸ í•„ìš”)");
    }
    
    // 2. PPT ê°ì²´ ìƒì„±
    let pptx = new window.PptxGenJS();
    pptx.layout = 'LAYOUT_16x9';

    // 3. ë§ˆìŠ¤í„° ìŠ¬ë¼ì´ë“œ (ë¸Œëœë“œ ë””ìì¸)
    pptx.defineSlideMaster({
        title: 'BRAND_MASTER',
        background: { color: 'FFFFFF' },
        objects: [
            { rect: { x: 0, y: 0, w: '100%', h: 0.15, fill: '2563EB' } }, // ìƒë‹¨ íŒŒë€ ë 
            { text: { text: 'AI Design Library - Auto Generated', options: { x: 0.5, y: 0.2, color: '94a3b8', fontSize: 10 } } },
            { rect: { x: 0, y: 5.4, w: '100%', h: 0.2, fill: 'F1F5F9' } } // í•˜ë‹¨ íšŒìƒ‰ ë 
        ]
    });

    // 4. í‘œì§€ ìŠ¬ë¼ì´ë“œ ìƒì„±
    let slide1 = pptx.addSlide({ masterName: 'BRAND_MASTER' });
    slide1.addText("2026 Design Resource Strategy", { x: 1, y: 2, fontSize: 36, color: '1e293b', bold: true });
    slide1.addText("Based on Uploaded Assets", { x: 1, y: 2.8, fontSize: 18, color: '64748b' });
    slide1.addText("Generated by AI Helper", { x: 8, y: 5, fontSize: 12, color: '2563EB' });

    // 5. ë°ì´í„° êµ¬ì¡° í‰íƒ„í™” (Object -> Array ë³€í™˜)
    let allResources = [];
    if (Array.isArray(db)) {
        allResources = db; // ì´ë¯¸ ë°°ì—´ì´ë©´ ê·¸ëŒ€ë¡œ
    } else {
        // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ë¬¶ì—¬ìˆìœ¼ë©´ ë‹¤ êº¼ë‚´ì„œ í•œ ì¤„ë¡œ í•©ì¹¨
        allResources = Object.values(db).flat();
    }

    // ë°ì´í„°ê°€ ë¹„ì—ˆëŠ”ì§€ í™•ì¸
    if (!allResources || allResources.length === 0) {
        console.error("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. data.jsë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
        return;
    }

    // 6. ì•ì—ì„œ 4ê°œë§Œ ë½‘ì•„ì„œ ìŠ¬ë¼ì´ë“œ ë§Œë“¤ê¸°
    const resources = allResources.slice(0, 4); 

    resources.forEach((item, index) => {
        let slide = pptx.addSlide({ masterName: 'BRAND_MASTER' });
        
        // ì œëª©
        slide.addText(`0${index + 1}. ${item.title || 'Untitled Resource'}`, { x: 0.5, y: 0.8, fontSize: 24, color: '1e293b', bold: true });
        
        // ì„¤ëª…
        slide.addText(item.desc || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.', { x: 0.5, y: 1.5, w: 4.5, fontSize: 14, color: '475569', lineSpacing: 20 });
        
        // íƒœê·¸
        const tags = item.tags ? item.tags.join("  ") : "#Design #Resource";
        slide.addText(`Analyzed Keywords: ${tags}`, { x: 0.5, y: 4.5, fontSize: 10, color: '2563EB' });

        // â­ [ì¤‘ìš”] ì´ë¯¸ì§€ ê²½ë¡œ ì ˆëŒ€ ì£¼ì†Œ ë³€í™˜ â­
        if (item.thumb) {
            try {
                // í˜„ì¬ ì‚¬ì´íŠ¸ ì£¼ì†Œ(window.location.href)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì´ë¯¸ì§€ì˜ ì „ì²´ ì£¼ì†Œë¥¼ ë§Œë“­ë‹ˆë‹¤.
                // ì˜ˆ: "images/a.jpg" -> "https://my-site.com/images/a.jpg"
                const absolutePath = new URL(item.thumb, window.location.href).href;
                
                console.log(`ìŠ¬ë¼ì´ë“œ ${index+1} ì´ë¯¸ì§€ ì¶”ê°€:`, absolutePath); // í™•ì¸ìš© ë¡œê·¸

                slide.addImage({ 
                    path: absolutePath,
                    x: 5.5, y: 1.2, w: 4, h: 3,
                    rounding: true
                });
            } catch (err) {
                console.warn(`ì´ë¯¸ì§€ ê²½ë¡œ ë³€í™˜ ì‹¤íŒ¨ (${item.title}):`, err);
            }
        }
    });

    // 7. íŒŒì¼ ì €ì¥ (ë‹¤ìš´ë¡œë“œ ì‹œì‘)
    await pptx.writeFile({ fileName: 'AI_Analysis_Report.pptx' });
}


// ============================================================
// 2. UI ë° ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ë””ìì¸ ìœ ì§€)
// ============================================================
const style = `
<style>
    @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;700&display=swap');
    
    .ai-fab { position: fixed; bottom: 30px; right: 30px; background: #1e293b; color: white; padding: 12px 24px; border-radius: 30px; display: flex; align-items: center; gap: 10px; font-family: 'Pretendard', sans-serif; font-weight: 700; box-shadow: 0 10px 25px rgba(0,0,0,0.3); cursor: pointer; z-index: 9000; transition: transform 0.2s; animation: pulse-black 2s infinite; }
    .ai-fab:hover { transform: scale(1.05); animation: none; background: black; }
    @keyframes pulse-black { 0% { box-shadow: 0 0 0 0 rgba(30, 41, 59, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(30, 41, 59, 0); } 100% { box-shadow: 0 0 0 0 rgba(30, 41, 59, 0); } }
    .ai-fab span { font-size: 1rem; } .ai-icon { font-size: 1.2rem; color: #fbbf24; }
    
    .ai-tooltip { position: fixed; bottom: 95px; right: 30px; background: white; color: #334155; padding: 12px 20px; border-radius: 16px; border-bottom-right-radius: 4px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); font-size: 0.95rem; font-weight: 600; z-index: 8999; font-family: 'Pretendard', sans-serif; animation: float 3s ease-in-out infinite; pointer-events: none; transition: opacity 0.3s; }
    .ai-tooltip::after { content: ''; position: absolute; bottom: -6px; right: 20px; width: 12px; height: 12px; background: white; transform: rotate(45deg); }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    .ai-tooltip.hidden { opacity: 0; }

    .prompt-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); z-index: 9998; display: none; opacity: 0; transition: opacity 0.3s ease; }
    .prompt-modal { position: fixed; top: 20%; left: 50%; transform: translateX(-50%) translateY(20px); width: 600px; max-width: 90%; background: white; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); z-index: 9999; display: none; flex-direction: column; overflow: hidden; font-family: 'Pretendard', sans-serif; transition: all 0.3s ease; }
    
    .input-area { display: flex; align-items: center; padding: 20px 24px; border-bottom: 1px solid transparent; }
    .input-area.has-result { border-bottom: 1px solid #f1f5f9; }
    .magic-icon { font-size: 1.5rem; margin-right: 15px; color: #64748b; animation: spin-slow 10s infinite linear; }
    .prompt-input { flex: 1; border: none; outline: none; font-size: 1.2rem; font-weight: 500; color: #1e293b; background: transparent; }
    .prompt-input::placeholder { color: #cbd5e1; }
    
    .result-area { background: #f8fafc; padding: 0; max-height: 0; overflow-y: auto; transition: max-height 0.4s ease, padding 0.4s ease; }
    .result-content { font-size: 1rem; line-height: 1.7; color: #334155; white-space: pre-wrap; }
    .result-area.show { padding: 24px; max-height: 300px; }
    
    .chips-area { padding: 12px 24px 20px 24px; display: flex; gap: 8px; flex-wrap: wrap; }
    .chip { background: white; border: 1px solid #e2e8f0; border-radius: 20px; padding: 6px 14px; font-size: 0.85rem; color: #64748b; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
    .chip:hover { border-color: #2563eb; color: #2563eb; background: #eff6ff; }
    
    @keyframes spin-slow { 100% { transform: rotate(360deg); } }
    .blinking-cursor { display: inline-block; width: 6px; height: 18px; background: #2563eb; animation: blink 1s infinite; vertical-align: middle; margin-left: 4px; }
    @keyframes blink { 50% { opacity: 0; } }
</style>
`;
document.head.insertAdjacentHTML('beforeend', style);

// HTML êµ¬ì¡° ë Œë”ë§
const html = `
    <div class="ai-tooltip" id="aiTooltip">ğŸ¤– í•„ìš”í•œ ìë£Œë¥¼ AIì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”!</div>
    <div class="ai-fab" onclick="openPrompt()">
        <i class="ph-fill ph-sparkle ai-icon"></i><span>Ask AI</span>
    </div>
    <div class="prompt-overlay" id="promptOverlay" onclick="closePrompt()"></div>
    <div class="prompt-modal" id="promptModal">
        <div class="input-area" id="inputArea">
            <i class="ph-fill ph-sparkle magic-icon"></i>
            <input type="text" class="prompt-input" id="promptInput" placeholder="ë¬´ì—‡ì„ ì°¾ì•„ë“œë¦´ê¹Œìš”? (ì˜ˆ: PPT ë§Œë“¤ì–´ì¤˜)" autocomplete="off" onkeypress="handleEnter(event)">
        </div>
        <div class="chips-area" id="chipsArea">
            <div class="chip" onclick="askChip('ì „ëµ ë³´ê³ ì„œ PPT ë§Œë“¤ì–´ì¤˜')"><i class="ph-fill ph-slideshow"></i> PPT 5ì¥ ìƒì„±</div>
            <div class="chip" onclick="askChip('ì „ëµ ë³´ê³ ì„œ ì°¾ì•„ì¤˜')"><i class="ph ph-magnifying-glass"></i> ì „ëµ ë³´ê³ ì„œ</div>
            <div class="chip" onclick="askChip('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜ í•´ê²°ë²•')"><i class="ph ph-warning-circle"></i> ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜</div>
        </div>
        <div class="result-area" id="resultArea">
            <div class="result-content" id="resultContent"></div>
        </div>
    </div>
`;
document.body.insertAdjacentHTML('beforeend', html);


// ============================================================
// 3. ë¡œì§ (Logic)
// ============================================================

const overlay = document.getElementById('promptOverlay');
const modal = document.getElementById('promptModal');
const input = document.getElementById('promptInput');
const resultArea = document.getElementById('resultArea');
const resultContent = document.getElementById('resultContent');
const chipsArea = document.getElementById('chipsArea');
const tooltip = document.getElementById('aiTooltip');

window.openPrompt = function() {
    overlay.style.display = 'block';
    modal.style.display = 'flex';
    tooltip.classList.add('hidden');
    setTimeout(() => { overlay.style.opacity = '1'; modal.style.transform = 'translateX(-50%) translateY(0)'; modal.style.opacity = '1'; input.focus(); }, 10);
}

window.closePrompt = function() {
    overlay.style.opacity = '0';
    modal.style.opacity = '0';
    modal.style.transform = 'translateX(-50%) translateY(20px)';
    setTimeout(() => { overlay.style.display = 'none'; modal.style.display = 'none'; tooltip.classList.remove('hidden'); resetPrompt(); }, 300);
}

window.handleEnter = function(e) { if (e.key === 'Enter') runAI(); }
window.askChip = function(question) { input.value = question; runAI(); }

function runAI() {
    const text = input.value.trim();
    if (!text) return;

    chipsArea.style.display = 'none';
    document.getElementById('inputArea').classList.add('has-result');
    resultArea.classList.add('show');
    resultContent.innerHTML = '<span style="color:#64748b">AIê°€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ PPT êµ¬ì¡°ë¥¼ ì„¤ê³„ ì¤‘ì…ë‹ˆë‹¤... <span class="blinking-cursor"></span></span>';

    setTimeout(async () => {
        // ğŸ”¥ PPT ìƒì„± ëª…ë ¹ì–´ ì¸ì‹
        if (text.includes("PPT") || text.includes("ë§Œë“¤ì–´") || text.includes("ìŠ¬ë¼ì´ë“œ")) {
            
            resultContent.innerHTML = "âœ… <strong>ë””ìì¸ ë¦¬ì†ŒìŠ¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ PPT ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤!</strong><br><br><code>data.js</code>ì˜ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ìŠ¬ë¼ì´ë“œì— ì´ë¯¸ì§€ë¥¼ ë°°ì¹˜í•©ë‹ˆë‹¤...";
            
            try {
                // â­ ì—¬ê¸°ì„œ ì§„ì§œ PPT ìƒì„± í•¨ìˆ˜ ì‹¤í–‰
                await createDynamicPPT(); 
                
                setTimeout(() => {
                    typeWriter("ğŸ‰ <strong>PPT ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</strong><br>ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ì„ ì—´ì–´ë³´ì„¸ìš”.<br>ì‚¬ì´íŠ¸ì— ìˆëŠ” <strong>ì¸ë„¤ì¼ ì´ë¯¸ì§€</strong>ê°€ ì‹¤ì œë¡œ ìŠ¬ë¼ì´ë“œì— í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }, 1500);
            } catch (e) {
                console.error(e);
                typeWriter(`âŒ PPT ìƒì„± ì˜¤ë¥˜: ${e.message}<br>ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`);
            }

        } else {
            // ì¼ë°˜ ëŒ€í™” (ê°€ì§œ ë‹µë³€)
            let answer = "ì£„ì†¡í•´ìš”, ê·¸ê±´ ì œê°€ í•  ìˆ˜ ì—†ëŠ” ì¼ì´ì—ìš”. ğŸ˜…";
            if (text.includes("ë³´ê³ ì„œ")) answer = "ë„¤, <strong>101ë²ˆ '2026 ì „ëµ ë³´ê³ ì„œ'</strong>ê°€ ê°€ì¥ ì í•©í•´ ë³´ì…ë‹ˆë‹¤.";
            else if (text.includes("ì•ˆë…•")) answer = "ë°˜ê°‘ìŠµë‹ˆë‹¤! AI ë””ìì¸ í—¬í¼ì…ë‹ˆë‹¤. ğŸ¤–";
            else if (text.includes("ë‹¤ìš´") || text.includes("ì˜¤ë¥˜")) answer = "ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì„ ëˆ„ë¥´ì‹œë©´ êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë·°ì–´ê°€ ìƒˆ ì°½ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.";
            
            typeWriter(answer);
        }
    }, 1500);
}

function typeWriter(htmlText) {
    resultContent.style.opacity = 0;
    resultContent.innerHTML = htmlText;
    let op = 0.1;
    let timer = setInterval(function () {
        if (op >= 1) clearInterval(timer);
        resultContent.style.opacity = op;
        op += op * 0.1;
    }, 30);
}

function resetPrompt() {
    input.value = '';
    resultArea.classList.remove('show');
    document.getElementById('inputArea').classList.remove('has-result');
    chipsArea.style.display = 'flex';
    resultContent.innerHTML = '';
}

// í‚¤ë³´ë“œ ì´ë²¤íŠ¸
document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); if (modal.style.display === 'flex') closePrompt(); else openPrompt(); }
    if (e.key === 'Escape') closePrompt();
});