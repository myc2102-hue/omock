<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>커피요정찰스 - 커피주문기</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #1d1d1f; --accent: #0071e3; --ice: #64d2ff; --hot: #ff3b30; --shot: #34c759; --bg: #f5f5f7; --card: rgba(255, 255, 255, 0.8); }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--primary); }
        .container { max-width: 500px; margin: 0 auto; padding: 25px; background: var(--card); border-radius: 28px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); }
        h1 { text-align: center; font-size: 24px; margin-bottom: 20px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .modal-box { background: white; padding: 25px; border-radius: 20px; text-align: center; width: 85%; max-width: 320px; }
        .modal-box input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px; box-sizing: border-box; }
        .tabs { display: flex; background: #e8e8ed; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 10px; text-align: center; border-radius: 8px; cursor: pointer; font-size: 14px; color: #86868b; }
        .tab.active { background: white; color: black; font-weight: bold; }
        .timer-banner { background: var(--primary); color: white; padding: 15px; border-radius: 15px; text-align: center; margin-bottom: 20px; }
        .menu-item { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid #eee; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .order-btn { padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .order-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-ice { background: #eef5ff; color: var(--accent); }
        .btn-hot { background: #fff1f1; color: var(--hot); }
        .order-summary { background: white; border-radius: 20px; padding: 20px; margin-top: 20px; }
    </style>
</head>
<body>

<div id="modal-login" class="modal-overlay" style="display: flex;">
    <div class="modal-box">
        <h3>☕ 성함을 입력해주세요</h3>
        <input type="text" id="user-input" placeholder="이름 입력" onkeypress="if(event.keyCode==13) login()">
        <button onclick="login()" style="width:100%; padding:12px; background:var(--accent); color:white; border:none; border-radius:10px;">입장하기</button>
    </div>
</div>

<div id="modal-confirm" class="modal-overlay">
    <div class="modal-box">
        <h4 id="confirm-msg"></h4>
        <div style="display:flex; gap:10px;">
            <button onclick="closeConfirm()" style="flex:1; padding:10px; border:none; border-radius:8px;">취소</button>
            <button id="final-order-btn" style="flex:1; padding:10px; background:var(--accent); color:white; border:none; border-radius:8px;">주문확정</button>
        </div>
    </div>
</div>

<div class="container">
    <h1>커피요정찰스</h1>
    <p id="user-display" style="text-align:center; font-size:14px; color:#666; display:none;">
        <span id="current-user"></span> 님 ☕
    </p>

    <div class="tabs">
        <div id="tab-morning" class="tab active" onclick="switchTab('morning')">아침 (07:00~)</div>
        <div id="tab-daily" class="tab" onclick="switchTab('daily')">주간 (09:00~)</div>
    </div>

    <div class="timer-banner">
        <div id="timer-label" style="font-size:12px; opacity:0.7;">상태 확인 중...</div>
        <div id="time-left" style="font-size:20px; font-weight:bold;">00:00:00</div>
    </div>

    <div id="menu-container">
        <div class="menu-item">
            <p style="text-align:center; font-weight:bold;">아메리카노</p>
            <div class="btn-grid">
                <button class="order-btn btn-ice" onclick="openConfirm('아메리카노(Ice)')">Ice</button>
                <button class="order-btn btn-hot" onclick="openConfirm('아메리카노(Hot)')">Hot</button>
            </div>
        </div>
        <div class="menu-item">
            <p style="text-align:center; font-weight:bold;">카페라떼</p>
            <div class="btn-grid">
                <button class="order-btn btn-ice" onclick="openConfirm('라떼(Ice)')">Ice</button>
                <button class="order-btn btn-hot" onclick="openConfirm('라떼(Hot)')">Hot</button>
            </div>
        </div>
    </div>

    <div class="order-summary">
        <p style="font-weight:bold; border-bottom:1px solid #eee; padding-bottom:10px;">주문 현황</p>
        <div id="grouped-list" style="font-size:14px; line-height:1.8;"></div>
        <p style="text-align:right; font-weight:bold; margin-top:15px;">총 <span id="total-count">0</span>잔</p>
        <button onclick="clearAllOrders()" style="width:100%; background:none; border:none; color:#999; font-size:11px; margin-top:20px; cursor:pointer; text-decoration:underline;">전체 초기화 (관리자)</button>
    </div>
</div>

<script>
    // 1. 파이어베이스 초기화
    const firebaseConfig = {
        apiKey: "AIzaSyBSxM3W_RkCt8poqQJxVhIgYMPqLuZgT6Y",
        authDomain: "menusame-6a326.firebaseapp.com",
        databaseURL: "https://menusame-6a326-default-rtdb.firebaseio.com",
        projectId: "menusame-6a326",
        storageBucket: "menusame-6a326.firebasestorage.app",
        messagingSenderId: "822750462446",
        appId: "1:822750462446:web:1cc67bd3f2b49e52670eff"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let userName = "";
    let currentCategory = 'morning';
    const TIMES = {
        morning: { open: 7*3600, close: 7*3600+58*60 },
        daily: { open: 9*3600, close: 18*3600 }
    };

    // 2. 로그인 함수
    function login() {
        const val = document.getElementById('user-input').value.trim();
        if(!val) return;
        userName = val;
        document.getElementById('modal-login').style.display = 'none';
        document.getElementById('user-display').style.display = 'block';
        document.getElementById('current-user').innerText = userName;
        updateTimer();
    }

    // 3. 주문 함수 (가장 중요)
    function openConfirm(menu) {
        if(!userName) return alert("이름을 먼저 입력해주세요!");
        document.getElementById('confirm-msg').innerText = `[${menu}] 주문할까요?`;
        document.getElementById('modal-confirm').style.display = 'flex';
        document.getElementById('final-order-btn').onclick = () => {
            const prefix = currentCategory === 'morning' ? "아침" : "주간";
            const orderKey = `${userName}|${prefix}_${menu}`;
            
            // 실시간 반영을 위해 transaction 사용
            db.ref('orders/' + orderKey).transaction(cv => (cv || 0) + 1)
                .then(() => console.log("주문 성공"))
                .catch(e => alert("오류 발생: " + e.message));
                
            closeConfirm();
        };
    }

    function closeConfirm() { document.getElementById('modal-confirm').style.display = 'none'; }

    // 4. 시간 및 초기화 로직
    function getKSTSeconds() {
        const now = new Date();
        const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
        const kr = new Date(utc + (9 * 3600000));
        return kr.getHours() * 3600 + kr.getMinutes() * 60 + kr.getSeconds();
    }

    function updateTimer() {
        const curSec = getKSTSeconds();
        const config = TIMES[currentCategory];
        const isOpen = curSec >= config.open && curSec < config.close;

        // 버튼 상태
        document.querySelectorAll('.order-btn').forEach(btn => btn.disabled = !isOpen || !userName);

        // 타이머 표시
        const timerEl = document.getElementById('time-left');
        const labelEl = document.getElementById('timer-label');
        if(isOpen) {
            labelEl.innerText = "영업 중";
            const diff = config.close - curSec;
            const h = Math.floor(diff/3600).toString().padStart(2,'0');
            const m = Math.floor((diff%3600)/60).toString().padStart(2,'0');
            const s = (diff%60).toString().padStart(2,'0');
            timerEl.innerText = `${h}:${m}:${s}`;
        } else {
            labelEl.innerText = "영업 종료";
            timerEl.innerText = "00:00:00";
        }

        // 매일 첫 접속 시 자동 초기화 (localStorage 이용)
        const today = new Date().toLocaleDateString();
        const resetKey = `reset_${currentCategory}_${today}`;
        if(isOpen && !localStorage.getItem(resetKey)) {
            db.ref('orders').remove();
            localStorage.setItem(resetKey, 'true');
        }
    }

    function switchTab(type) {
        currentCategory = type;
        document.getElementById('tab-morning').classList.toggle('active', type==='morning');
        document.getElementById('tab-daily').classList.toggle('active', type==='daily');
        updateTimer();
    }

    // 5. 데이터 실시간 감시 (화면 그리기)
    db.ref('orders').on('value', (snapshot) => {
        const data = snapshot.val() || {};
        const listEl = document.getElementById('grouped-list');
        const countEl = document.getElementById('total-count');
        
        let html = ""; let total = 0;
        let grouped = {};

        Object.keys(data).forEach(key => {
            const [name, menuRaw] = key.split('|');
            const menu = menuRaw.split('_')[1];
            const qty = data[key];
            if(!grouped[menu]) grouped[menu] = [];
            grouped[menu].push(`${name}(${qty})`);
            total += qty;
        });

        Object.keys(grouped).forEach(m => {
            html += `<strong>${m}</strong>: ${grouped[m].join(', ')}<br>`;
        });

        listEl.innerHTML = html || "주문 내역이 없습니다.";
        countEl.innerText = total;
    });

    function clearAllOrders() { if(confirm("정말 모두 초기화할까요?")) db.ref('orders').remove(); }

    setInterval(updateTimer, 1000);
</script>
</body>
</html>