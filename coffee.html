<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBSxM3W_RkCt8poqQJxVhIgYMPqLuZgT6Y",
        authDomain: "menusame-6a326.firebaseapp.com",
        databaseURL: "https://menusame-6a326-default-rtdb.firebaseio.com",
        projectId: "menusame-6a326",
        storageBucket: "menusame-6a326.firebasestorage.app",
        messagingSenderId: "822750462446",
        appId: "1:822750462446:web:1cc67bd3f2b49e52670eff"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let userName = "";
    let currentCategory = 'morning';
    const TIMES = {
        morning: { open: 7*3600, close: 7*3600+58*60, label: "아침 (07:00~07:58)" },
        daily: { open: 9*3600, close: 18*3600, label: "주간 (09:00~18:00)" }
    };

    function login() {
        const input = document.getElementById('user-input').value.trim();
        if(!input) return;
        userName = input;
        document.getElementById('modal-login').style.display = 'none';
        document.getElementById('user-display').style.display = 'block';
        document.getElementById('current-user').innerText = userName;
        // 로그인 성공 시 즉시 버튼 상태 업데이트
        updateTimer();
    }

    function openConfirm(menu) {
        // 이름이 없으면 주문창을 띄우지 않음
        if(!userName) {
            alert("이름을 입력해야 주문이 가능합니다.");
            location.reload();
            return;
        }
        const confirmModal = document.getElementById('modal-confirm');
        document.getElementById('confirm-msg').innerHTML = `<b>${userName}</b>님,<br>[${menu}]을(를) 주문하시겠습니까?`;
        confirmModal.style.display = 'flex';
        document.getElementById('final-order-btn').onclick = function() {
            addOrder(menu);
            closeConfirm();
        };
    }

    function addOrder(menu) {
        const prefix = currentCategory === 'morning' ? "아침" : "주간";
        const orderKey = `${userName}|${prefix}_${menu}`;
        
        // 1. 카운팅이 안 될 때를 대비해 알림 표시
        console.log("주문 시도:", orderKey);

        db.ref('orders/' + orderKey).transaction((cv) => {
            return (cv || 0) + 1;
        }, (error, committed, snapshot) => {
            if (error) {
                alert("주문 전송 오류: " + error.message);
            } else if (!committed) {
                console.log("주문이 중단되었습니다.");
            } else {
                console.log("주문 성공!");
            }
        });
    }

    function updateTimer() {
        const curSec = getKSTSeconds();
        const config = TIMES[currentCategory];
        const timerEl = document.getElementById('time-left');
        const labelEl = document.getElementById('timer-label');
        const btns = document.querySelectorAll('.order-btn'); // 모든 주문 버튼 대상

        const isOpen = curSec >= config.open && curSec < config.close;
        
        // 버튼 활성화 로직 보강
        btns.forEach(btn => {
            // 1. 영업 시간이고 2. 이름이 입력된 상태여야 클릭 가능
            btn.disabled = !(isOpen && userName !== "");
            // 디버깅용: 버튼 클릭이 안 되면 이유를 투명도로 표시
            btn.style.opacity = btn.disabled ? "0.5" : "1";
        });

        if (isOpen) {
            labelEl.innerText = "영업 중";
            const diff = config.close - curSec;
            timerEl.innerText = `${Math.floor(diff/3600).toString().padStart(2,'0')}:${Math.floor((diff%3600)/60).toString().padStart(2,'0')}:${(diff%60).toString().padStart(2,'0')}`;
        } else {
            labelEl.innerText = "영업 종료";
            timerEl.innerText = "00:00:00";
        }

        // [자동 초기화 로직 유지]
        const todayStr = new Date().toLocaleDateString();
        const clearKey = `cleared_${currentCategory}_${todayStr}`;
        if (isOpen && !localStorage.getItem(clearKey)) {
            db.ref('orders').once('value', (snapshot) => {
                if (snapshot.exists()) db.ref('orders').remove();
                localStorage.setItem(clearKey, 'true');
            });
        }
    }

    // ... 기타 함수(getKSTSeconds, switchTab 등) 동일 ...
    setInterval(updateTimer, 1000);
</script>